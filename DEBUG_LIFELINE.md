# 人生 K 线功能调试指南

## 已修复的问题

### 1. ✅ 参数传递问题
**问题**: 跳转到结果页面时参数未传递

**修复**:
- 在 `KLineChart.jsx` 中增强了参数验证
- 确保所有参数都是有效数字
- 添加了详细的参数日志输出
- 添加时间戳确保每次跳转都是新状态

**调试日志**:
- `📤 准备跳转到结果页面`
- `📤 requestParams 完整数据: {...}`
- `✅ 参数验证通过，准备跳转`
- `✅ 已触发跳转，state 已设置`

### 2. ✅ 路由状态丢失问题
**问题**: `LifeLineResultPage` 中 `location.state` 为空

**修复**:
- 增强了 `location.state` 的处理逻辑
- 添加了详细的日志输出用于调试
- 增加了参数完整性验证
- 保留了 URL 参数作为备用方案

**调试日志**:
- `📍 LifeLineResultPage - location 对象: {...}`
- `📍 LifeLineResultPage - location.state: {...}`
- `✅ 从 location.state 获取到参数: {...}`
- `⚠️ location.state 或 location.state.requestParams 不存在` (如果状态丢失)

### 3. ✅ API 调用失败问题
**问题**: API 调用失败，错误信息不明确

**修复**:
- 增强了错误处理
- 添加了详细的请求和响应日志
- 增加了参数验证
- 改进了错误信息输出

**调试日志**:
- `🌐 调用 generateLifeLine API`
- `📦 请求参数: {...}`
- `📥 API 响应状态: 200 OK`
- `✅ API 调用成功，返回数据: {...}`
- `❌ API 调用失败: ...` (如果失败)

## 调试步骤

### 步骤 1: 检查参数传递
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 填写表单并点击生成按钮
4. 查看以下日志：
   - `📤 准备跳转到结果页面`
   - `📤 requestParams 完整数据: {...}`
   - 确认所有必需字段都存在且为有效数字

### 步骤 2: 检查路由状态
1. 在结果页面加载时，查看以下日志：
   - `📍 LifeLineResultPage - location.state: {...}`
   - `✅ 从 location.state 获取到参数: {...}`
2. 如果看到 `⚠️ location.state 或 location.state.requestParams 不存在`：
   - 检查是否使用了浏览器的前进/后退按钮（会丢失 state）
   - 尝试重新填写表单并跳转

### 步骤 3: 检查 API 调用
1. 查看以下日志：
   - `🌐 调用 generateLifeLine API`
   - `📦 请求参数: {...}`
   - `📥 API 响应状态: 200 OK`
   - `✅ API 调用成功，返回数据: {...}`
2. 如果看到错误：
   - 检查后端服务是否运行：`lsof -ti:8000`
   - 检查网络请求（Network 标签）：
     - 请求 URL 是否正确
     - 请求方法是否为 POST
     - 请求体是否包含所有必需字段
     - 响应状态码和内容

### 步骤 4: 检查后端日志
1. 查看后端终端输出：
   - `📊 收到人生 K 线请求: ...`
   - `✅ 人生 K 线生成成功，返回 101 个数据点`
   - `⚠️ LifeLineService 调用失败: ...` (如果 AI 调用失败)

## 常见问题

### Q1: location.state 为空
**原因**: 
- 使用了浏览器的前进/后退按钮
- 直接访问 URL（没有通过 navigate 跳转）

**解决方案**:
- 使用 URL 参数作为备用方案（已实现）
- 或者使用 sessionStorage 存储参数

### Q2: API 返回 404
**原因**: 
- 后端服务未运行
- API 路径错误

**解决方案**:
- 检查后端服务：`lsof -ti:8000`
- 确认 API URL: `http://localhost:8000/api/divination/life-line`

### Q3: API 返回 400
**原因**: 
- 参数格式错误
- 缺少必需字段

**解决方案**:
- 查看后端日志中的错误详情
- 检查前端发送的参数格式

### Q4: API 返回 500
**原因**: 
- 后端内部错误
- DeepSeek API 调用失败

**解决方案**:
- 查看后端日志中的错误堆栈
- 检查 `.env` 文件中的 `DEEPSEEK_API_KEY` 配置

## 测试检查清单

- [ ] 参数传递：查看 `📤 准备跳转到结果页面` 日志
- [ ] 路由状态：查看 `📍 LifeLineResultPage - location.state` 日志
- [ ] API 调用：查看 `🌐 调用 generateLifeLine API` 日志
- [ ] 数据返回：查看 `✅ API 调用成功` 日志
- [ ] 数据渲染：检查页面是否显示图表和数据

## 联系支持

如果问题仍然存在，请提供：
1. 浏览器控制台的完整日志
2. 后端终端的完整日志
3. 网络请求的详细信息（Network 标签）
