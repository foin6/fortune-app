stages:
  - build
  - test
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

# 前端构建
build_frontend:
  stage: build
  image: node:${NODE_VERSION}
  cache:
    paths:
      - frontend/node_modules/
  script:
    - cd frontend
    - npm ci
    # 如果设置了 VITE_API_BASE_URL 环境变量，使用它；否则使用默认值
    - |
      if [ -n "$VITE_API_BASE_URL" ]; then
        echo "VITE_API_BASE_URL=$VITE_API_BASE_URL" > .env.production
      fi
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 hour
  only:
    - main
    - master

# 后端测试
test_backend:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - python -m pytest tests/ || echo "No tests found, skipping"
    - python -c "import main; print('Backend imports successfully')"
  only:
    - main
    - master

# 构建 Docker 镜像（可选）
build_docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - master
  when: manual

# 部署前端到 GitLab Pages
deploy_pages:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying to GitLab Pages..."
    - mkdir -p public
    - cp -r frontend/dist/* public/
  artifacts:
    paths:
      - public
  only:
    - main
    - master
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME

# 部署到服务器（需要配置 SSH 密钥）
deploy_backend:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - echo "Deploying backend to $DEPLOY_SERVER_HOST..."
    - rsync -avz --exclude='.git' --exclude='node_modules' --exclude='frontend' . $DEPLOY_SERVER_USER@$DEPLOY_SERVER_HOST:$DEPLOY_SERVER_PATH
    - ssh $DEPLOY_SERVER_USER@$DEPLOY_SERVER_HOST "cd $DEPLOY_SERVER_PATH && pip install -r requirements.txt && systemctl restart fortune-app || echo 'Service not configured'"
  only:
    - main
    - master
  when: manual
  environment:
    name: production
    url: http://$DEPLOY_SERVER_HOST
